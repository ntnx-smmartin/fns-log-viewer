# Load required modules
module(load="imudp")
module(load="ommysql")

# Enable UDP syslog reception on port 514
input(type="imudp" port="514" ruleset="nutanix_fns")

# Define template for file output
template(name="FNSFileFormat" type="string"
    string="%timestamp:::date-rfc3339% %hostname% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n")

# MySQL template using list format - NOW INCLUDING event_type
template(name="sql-fns" type="list" option.sql="on") {
    constant(value="INSERT INTO fns_logs (received_timestamp, hostname, os, event_timestamp, rule_uuid, rule_name, event_type, source, destination, protocol, source_port, destination_port, action, direction, originator_packets, originator_bytes, reply_packets, reply_bytes, description) VALUES ('")
    property(name="timereported" dateformat="mysql")
    constant(value="','")
    property(name="hostname")
    constant(value="','")
    property(name="$.os")
    constant(value="',STR_TO_DATE('")
    property(name="$.event_timestamp")
    constant(value="','%Y/%m/%d %H:%i:%s'),'")
    property(name="$.rule_uuid")
    constant(value="','")
    property(name="$.rule_name")
    constant(value="','")
    property(name="$.event_type")
    constant(value="','")
    property(name="$.source")
    constant(value="','")
    property(name="$.destination")
    constant(value="','")
    property(name="$.protocol")
    constant(value="',")
    property(name="$.source_port")
    constant(value=",")
    property(name="$.destination_port")
    constant(value=",'")
    property(name="$.action")
    constant(value="','")
    property(name="$.direction")
    constant(value="',")
    property(name="$.orig_pkts")
    constant(value=",")
    property(name="$.orig_bytes")
    constant(value=",")
    property(name="$.reply_pkts")
    constant(value=",")
    property(name="$.reply_bytes")
    constant(value=",'")
    property(name="$.desc_check")
    constant(value="')")
}

# Ruleset for processing Nutanix FNS logs
ruleset(name="nutanix_fns") {

    # Extract fields using regex
    set $.rawmsg = $msg;

    # Parse the message - pattern: INFO:YYYY/MM/DD HH:MM:SS  [UUID] RuleName [EventType] ...
    if (re_match($.rawmsg, "INFO:.*")) then {
        set $.event_timestamp = re_extract($.rawmsg, "INFO:([0-9]{4}/[0-9]{2}/[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2})", 0, 1, "");
        set $.rule_uuid = re_extract($.rawmsg, "\\[([a-f0-9-]+)\\]", 0, 1, "");
        set $.rule_name = re_extract($.rawmsg, "\\] ([^\\[]+) \\[", 0, 1, "");
        set $.event_type = re_extract($.rawmsg, "\\[([A-Za-z]+)\\] SRC=", 0, 1, "");
        set $.source = re_extract($.rawmsg, "SRC=([^ ]+)", 0, 1, "");
        set $.destination = re_extract($.rawmsg, "DST=([^ ]+)", 0, 1, "");
        set $.protocol = re_extract($.rawmsg, "PROTO=([^ ]+)", 0, 1, "");
        set $.source_port = re_extract($.rawmsg, "SPORT=([0-9]+)", 0, 1, "0");
        set $.destination_port = re_extract($.rawmsg, "DPORT=([0-9]+)", 0, 1, "0");
        set $.action = re_extract($.rawmsg, "ACTION=([^ ]+)", 0, 1, "");
        set $.direction = re_extract($.rawmsg, "DIRECTION=([^ ]+)", 0, 1, "");
        set $.orig_pkts = re_extract($.rawmsg, "ORIG: PKTS=([0-9]+)", 0, 1, "0");
        set $.orig_bytes = re_extract($.rawmsg, "ORIG: PKTS=[0-9]+ BYTES=([0-9]+)", 0, 1, "0");
        set $.reply_pkts = re_extract($.rawmsg, "REPLY: PKTS=([0-9]+)", 0, 1, "0");
        set $.reply_bytes = re_extract($.rawmsg, "REPLY: PKTS=[0-9]+ BYTES=([0-9]+)", 0, 1, "0");

        # Extract description if present
        set $.desc_check = re_extract($.rawmsg, "DESCRIPTION=(.+)", 0, 1, "");

        # Trim rule_name (remove leading/trailing spaces)
        set $.rule_name = ltrim($.rule_name);
        set $.rule_name = rtrim($.rule_name);

        # Strip trailing characters from syslogtag for OS field
        set $.os = replace($syslogtag, ":", "");
        set $.os = replace($.os, " ", "");

        # Also write to file
        action(type="omfile" file="/var/log/fns.log" template="FNSFileFormat")

        # Insert into MySQL database with template
        action(
            type="ommysql"
            server="127.0.0.1" # IP address or hostname of database server
            db="Syslog" # Database name
            uid="rsyslog" # Username for database
            pwd="4u/Nutanix!" # Password for database
            serverport="3306" # Port number for database
            template="sql-fns"
        )
    }
}